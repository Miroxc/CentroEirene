!function(e,t){"use strict";var n=t.isSecondaryComponent||function(){return!1};t.regExtension({name:"code-editor",global:{customTemplate:'<div mbr-id="_anchor" mbr-custom-code="true"></div>',encodeCodeEditorPHP:function(e,t){return t._PHPplaceholders=[],e.replace(/<\?[\w\W]+?\?>/g,(function(e){var n=t._PHPplaceholders.length;return t._PHPplaceholders.push(e),"[PHP_CODE_"+n+"]"}))},decodeCodeEditorPHP:function(e,t){return t._PHPplaceholders&&t._PHPplaceholders.length&&(e=(e=e.replace(/[[{]{1}PHP_CODE_([0-9]+)[\]}]{1}/gi,(function(e,n){return t._PHPplaceholders[n]||e}))).replace(/\?>=""/gi,"?>").replace(/\?>=''/gi,"?>")),e},encodeCodeEditorJS:function(e,t){return t._JSplaceholders=[],e.replace(/<script[\w\W]+?<\/script>/g,(function(e){var n=t._JSplaceholders.length;return-1===t._JSplaceholders.indexOf(e)&&t._JSplaceholders.push(e),-1!==e.indexOf('type="application/json"')||-1!==e.indexOf("type='application/json'")?e:"[JS_CODE_"+n+"]"}))},decodeCodeEditorJS:function(e,t){return t._JSplaceholders&&t._JSplaceholders.length&&(e=e.replace(/[[{]{1}JS_CODE_([0-9]+)[\]}]{1}/gi,(function(e,n){return t._JSplaceholders[n]||e}))),e},getComponentHTMLforEditor:function(t,n){return this.getResultHTML(this.currentPage,t).then(function(o){var i=this.applyFilter("resultHTMLforEditor",o,n||this.getComponent(t));return i.find("> *").removeAttr("id"),i.find("[data-app-edit]").each((function(){var t=e(this),n=t.attr("data-app-edit"),o="mbr-editable-"+n;if("buttons"===n){o="mbr-editable-button";t=t.find("[data-app-btn]")}if("menu"===n){o="mbr-editable-menu-item";t=t.find("[data-app-btn]")}t.addClass(o)})),i=i.html(),i=this.cleanHTMLplease(i),i=this.APP.preparePublishVideos(i),e.Deferred().resolve(i)}.bind(this))},convertComponentToCustomHTML:function(t){var n=this.getComponent(t);return this.fire("convertComponentToCustomHTML",t),this.getComponentHTMLforEditor(t,n).then(function(o){n._customHTML=o,n._customHTML=this.encodeCodeEditorPHP(n._customHTML,n),n._customHTML=this.encodeCodeEditorJS(n._customHTML,n);var i=this.getComponentStyles(n,!0);i=i.google+i.css,n._customCSS=i,delete n._styles,delete n._onParamsChange,delete n._publishFilter,n._customTemplate=!0;var r=e(this.customTemplate);rivets.bind(r,n),this.$template.find("[data-app-component-id="+t+"] > .app-component-content").html(r),this.$template.find("[data-app-component-id="+t+"] .app-component-menu .component-params").remove(),this.prepareCodeEditor(t),this.fire("convertedComponentToCustomHTML",t)}.bind(this))},addCodeEditableID:function(t){var o=this,i=o.getComponent(t);if(!n(i)&&void 0!==i._customHTML){var r=e("<div>").html(i._customHTML);r.find(".mbr-editable-content, .mbr-editable-full, .mbr-editable-button, .mbr-editable-menu-item, .mbr-editable-image").each((function(){e(this).attr("code-editable-id",o.uniqNum())})),i._customHTML=r.html(),r.remove()}},prepareCodeEditor:function(t,o,i){var r;if(o=o||this.$template,"object"==typeof t?t=(r=t)._id:r=this.getComponent(t),n(r)){var d=o.find("[data-app-component-id="+t+"] > .app-component-content"),a=this.getSecondaryComponent(r);if(!a.isActualTemplate()){i||d.find("> *").trigger("delete.cards");var c=a.update().createElementFromTemplate();rivets.unbind(d).bind(c,r),d.html(c),this.fire("loadedComponent",r,this.currentPage,o,i)}}else if(r._customHTML){if((d=o.find("[data-app-component-id="+t+"]")).find("[mbr-custom-code]").html(r._customHTML),!i){d.find(".app-component-content > *").trigger("add.cards"),d.css("min-height",0);var s=d.find("[mbr-custom-code] *").toArray().some((t=>0!==e(t).height()));0!==d.height()||s&&d.find("[mbr-custom-code] *").length||d.css("min-height","40px")}}},renderCodeEditorChanges:function(e){this.fire("renderCodeEditorChanges",e);var t=this.getComponent(e);return this.addCodeEditableID(e),this.prepareCodeEditor(e),this.fire("renderedCodeEditorChanges",e),this.renderComponentsStyles(!1,this.currentPage,t)},changeEditableElement:function(t){var n=this,o=e(t);if(o.is("[code-editable-id]")&&o.parents("[mbr-custom-code]:eq(0)").length){var i=o.attr("code-editable-id"),r=o.parents("[data-app-component-id]:eq(0)").attr("data-app-component-id"),d=n.getComponent(r);if(d._customHTML){var a=e("<div>").html(d._customHTML),c=a.find("[code-editable-id="+i+"]");if(o.is(".mbr-editable-button"))c.parent().html(n.cleanHTMLplease(o.parent().html(),!0));else if(o.is(".mbr-editable-menu-item"))c.parent().parent().html(n.cleanHTMLplease(o.parent().parent().html(),!0));else if(o.is(".mbr-editable-image"))c.attr("src",o.attr("src"));else{var s=e("<div>").html(o.clone());c.replaceWith(n.cleanHTMLplease(s.html(),!0)),s.remove()}d._customHTML=a.html(),a.remove()}}}},events:{load:function(){var t=this;t.addFilter("getResultHTMLcomponent",(function(e,n){return n._customHTML&&(e=t.decodeCodeEditorJS(e,n),e=t.decodeCodeEditorPHP(e,n)),e})),t.addFilter("getComponentParams",(function(e){return void 0!==e.current&&e})),t.addFilter("preventComponentStylesSave",(function(e,t,n,o,i,r){return t._customTemplate?(n.css(o,i),t._customCSS&&-1===t._customCSS.indexOf(r)&&(t._customCSS="@import url("+r+");\n"+t._customCSS),!0):e})),t.addFilter("summernoteEditableItems",(function(e,t){return t.is("[code-editable-id]:not(img)")?e.add(t):e})),t.addFilter("cleanHTMLplease",(function(e,t){return e.find("[code-editable-id]").removeAttr("contenteditable id"+(t?"":" data-app-btn data-app-list-item code-editable-id")).removeClass("note-air-editor note-editable"),e.find("[custom-code]").removeAttr("custom-code data-rv-view"),e})),t.addFilter("loadComponentTemplate",(function(e,n){return n._customTemplate?t.customTemplate:e})),t.addFilter("getComponentStyles",(function(e,t){return n(t)||void 0===t._customCSS||(e.css+=t._customCSS||""),e})),e.isEmptyObject(t.APP.projectSettings.theme)||t.APP.redrawStyleChanger(),t.$template.find(".app-component:eq(0)").length&&t.switchPage(t.currentPage)},loadedComponent:function(o,i,r){var d=t.$template.find('[data-app-component-id="'+o._id+'"]');d.height()<40&&!d.find(".app-component-content *").toArray().some((t=>0!==e(t).height()))&&d.css("min-height","40px"),n(o)||this.prepareCodeEditor(o,r,o._checkPublish())},summernoteBlur:function(e){this.changeEditableElement(e)}}})}(jQuery,mbrAppCore);